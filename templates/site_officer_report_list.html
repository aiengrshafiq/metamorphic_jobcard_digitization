{% extends "base.html" %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Report ID</th>
                        <th>Job Card</th>
                        <th>Project</th>
                        <th>Report Date</th>
                        <th>Submitted By</th>
                        <th class="text-end">Action</th>
                    </tr>
                </thead>
                <tbody id="reports-table-body"></tbody>
            </table>
            <p id="loading-state" class="text-center text-muted mt-3">Loading reports...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tableBody = document.getElementById('reports-table-body');
    const loadingState = document.getElementById('loading-state');

    

    async function fetchReports() {
        

        try {
            const response = await fetchWithAuth('/api/site-officer-reports/', {
                //headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to load data.');

           
            
            const reports = await response.json();
            
            if (reports.length === 0) {
                loadingState.textContent = 'No daily reports found.';
            } else {
                loadingState.style.display = 'none';
                tableBody.innerHTML = '';
                reports.forEach(report => {
                     const row = document.createElement('tr');
                    const reportDate = new Date(report.date).toLocaleDateString();

                    // --- NEW LOGIC TO HANDLE MULTIPLE JOB CARDS ---
                    let jcHtml = 'No Job Cards Linked';
                    if (report.job_cards && report.job_cards.length > 0) {
                        jcHtml = report.job_cards.map(jc => 
                            `<span class="badge bg-secondary me-1">${jc.job_card_no}</span>`
                        ).join(' ');
                    }
                    // We'll just display the first project name for simplicity in the list view
                    const projectName = report.job_cards.length > 0 ? report.job_cards[0].project.name : 'N/A';
                    // ----------------------------------------------
                    row.innerHTML = `
                        <td>${report.id}</td>
                        <td>${jcHtml}</td>
                        <td>${projectName}</td>
                        <td>${reportDate}</td>
                        <td>${report.created_by.name}</td>
                        <td class="text-end">
                            <a href="/site-officer-reports/${report.id}" class="btn btn-outline-secondary btn-sm" title="View Details">
                                <i class="bi bi-eye-fill"></i> View
                            </a>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        } catch (error) {
            loadingState.innerHTML = `<p class="text-danger">${error.message}</p>`;
        }
    }

    fetchReports();
});
</script>
{% endblock %}