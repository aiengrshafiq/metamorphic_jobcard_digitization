{% extends "base.html" %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<style>
    .choices__inner { background-color: var(--bs-body-bg); border-radius: var(--bs-border-radius); border: var(--bs-border-width) solid var(--bs-border-color); }
    .choices__input { background-color: transparent !important; color: var(--bs-body-color); }
    .choices[data-type*="select-one"]::after { border-color: var(--bs-body-color) transparent transparent; }
    .choices__list--dropdown .choices__item--selectable.is-highlighted { background-color: #0d6efd !important; }
    .accordion-button:not(.collapsed) { color: var(--bs-primary-color-rgb); background-color: var(--bs-primary-bg-subtle); }
    #video-recorder video { max-width: 100%; border-radius: .375rem; background-color: #000; }
    #image-preview-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
    .img-preview-wrapper { position: relative; width: 120px; height: 120px; }
    .img-preview { width: 100%; height: 100%; object-fit: cover; border-radius: .375rem; border: 1px solid #dee2e6; }
    .upload-progress { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; border-radius: .375rem; }
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-body p-4">
        <form id="site-officer-form" novalidate>
            <input type="hidden" name="toolbox_video_id" id="toolbox_video_id">
            <input type="hidden" name="site_image_ids" id="site_image_ids">

            <div class="accordion" id="formCAccordion">

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">Section 1: General Information</button></h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#formCAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-md-6"><label class="form-label">Date <span class="text-danger">*</span></label><input type="date" class="form-control" name="date" required></div>
                    <div class="col-md-6"><label class="form-label">Site Location </label><select class="form-select" name="site_location" ><option value="">Select...</option>{% for loc in site_locations %}<option value="{{ loc }}">{{ loc }}</option>{% endfor %}</select></div>
                    <div class="col-md-6">
        <label class="form-label">Name of Site Officer </label>
        <select class="form-select" name="site_officer_user_id" >
            <option value="">Select...</option>
            {% for so in supervisors %}
            <option value="{{ so.id }}">{{ so.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-6">
        <label class="form-label">Name of Duty Officer/Foreman </label>
        <select class="form-select" name="duty_officer_user_id" >
            <option value="">Select...</option>
            {% for f in foremen %}
            <option value="{{ f.id }}">{{ f.name }}</option>
            {% endfor %}
        </select>
    </div>
                </div></div></div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">Section 2: Toolbox Talk</button></h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#formCAccordion">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <div class="col-12" id="video-recorder">
                                    <label class="form-label fw-bold">Toolbox Video (Optional)</label>
                                    <div class="card border"><div class="card-body text-center p-2"><video id="video-preview" class="w-100" playsinline autoplay muted></video><div id="video-status" class="mt-2 text-muted small"></div>
                                    <div id="video-controls" class="mt-2 d-flex justify-content-center gap-2">
                                        <button type="button" class="btn btn-sm btn-danger" id="record-btn"><i class="bi bi-record-circle me-1"></i> Record</button>
                                        <button type="button" class="btn btn-sm btn-secondary" id="stop-btn" style="display: none;"><i class="bi bi-stop-circle me-1"></i> Stop</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="switch-camera-btn" style="display: none;" title="Switch Camera"><i class="bi bi-camera-video-reverse"></i>Switch Camera</button>
                                        <button type="button" class="btn btn-sm btn-info text-white" id="retake-btn" style="display: none;"><i class="bi bi-arrow-counterclockwise me-1"></i> Retake</button>
                                    </div></div></div>
                                </div>
                                <div class="col-12"><label class="form-label">Attendance (Names)</label><input type="text" class="form-control" name="tbt_attendance"></div>
                                <div class="col-12"><label class="form-label">Topic Discussed</label><input type="text" class="form-control" name="tbt_topic_discussed"></div>
                                <div class="col-12"><label class="form-label">Key Points</label><textarea class="form-control" name="tbt_key_points" rows="3"></textarea></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingEight"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEight" aria-expanded="false" aria-controls="collapseEight">Section 8: Housekeeping & Safety (with Images)</button></h2>
                    <div id="collapseEight" class="accordion-collapse collapse" aria-labelledby="headingEight" data-bs-parent="#formCAccordion">
                        <div class="accordion-body">
                            <div class="mb-4">
                                <label for="image-upload-input" class="form-label fw-bold">Upload Safety/Housekeeping Images:</label>
                                <input class="form-control" type="file" id="image-upload-input" accept="image/*" multiple>
                                <div id="image-preview-container"></div>
                            </div>
                            <hr>
                            <div class="row g-3 mt-1">
                                <div class="col-md-6"><label class="form-label">Site Waste Management</label><select class="form-select" name="hs_waste_management"><option value="">Select...</option>{% for opt in site_condition_options %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select></div>
                                <div class="col-md-6"><label class="form-label">Waste Management Comments</label><input type="text" class="form-control" name="hs_waste_management_comments"></div>
                                <div class="col-md-6"><label class="form-label">Walkways & Access Routes clear?</label><select class="form-select" name="hs_walkways_clear"><option value="">Select...</option>{% for opt in site_condition_options %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select></div>
                                <div class="col-md-6"><label class="form-label">Material Storage</label><select class="form-select" name="hs_material_storage"><option value="">Select...</option>{% for opt in site_condition_options %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select></div>
                                <div class="col-md-6"><label class="form-label">PPE Compliance</label><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="hs_ppe_compliance" value="true"></div></div>
                                <div class="col-md-6"><label class="form-label">Incidents / Near Misses</label><input type="text" class="form-control" name="hs_incidents_near_misses"></div>
                                <div class="col-12"><label class="form-label">Any safety comment</label><input type="text" class="form-control" name="hs_safety_comments"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">Section 3: Job Card Mapping</button></h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#formCAccordion"><div class="accordion-body"><div class="row g-3">
                        <div class="col-12"><label class="form-label">Select Job Card(s) <span class="text-danger">*</span></label><select class="form-select" name="job_card_ids" required multiple><option value="">Select...</option>{% for jc in job_cards %}<option value="{{ jc.id }}">{{ jc.job_card_no }} ({{ jc.project.name }})</option>{% endfor %}</select></div>
                        <div class="col-md-6"><label class="form-label">Have you ensured all duty officers completed Form B?</label><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="form_b_completed_check" value="true"></div></div><div class="col-md-6"><label class="form-label">Are progress pictures submitted by WhatsApp?</label><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="progress_pictures_check" value="true"></div></div><div class="col-12"><label class="form-label">Any dependency mark (with Job Card number)</label><input type="text" class="form-control" name="dependency_notes"></div></div></div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFour"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">Section 4: Site Management</button></h2>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#formCAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-12"><label class="form-label">Manpower Availability (With Meta codes)</label><textarea class="form-control" name="sm_manpower_availability" rows="2"></textarea></div><div class="col-md-6"><label class="form-label">Subcontractor Coordination</label><select class="form-select" name="sm_subcontractor_coordination"><option value="">Select...</option>{% for opt in subcontractor_coordination_c %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select></div><div class="col-md-6"><label class="form-label">If Have Issue Please Mention</label><input type="text" class="form-control" name="sm_coordination_issues"></div><div class="col-12"><label class="form-label">Other Notes (If Any)</label><textarea class="form-control" name="sm_other_notes" rows="2"></textarea></div></div></div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFive"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">Section 5: Material Requisition Checks</button></h2>
                    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#formCAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-md-8"><label class="form-label">Which Material Requested are submitted? (As per Form A)</label><select class="form-select" name="material_requisition_project_id"><option value="">Select Project...</option>{% for p in projects %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}</select></div><div class="col-md-4"><label class="form-label">Check for deliveries with Asst. Manager Commercial?</label><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="commercial_delivery_check" value="true"></div></div><div class="col-12"><label class="form-label">Any Comment related planned deliveries?</label><input type="text" class="form-control" name="delivery_comments"></div></div></div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSix"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSix" aria-expanded="false" aria-controls="collapseSix">Section 6: Quality Control</button></h2>
                    <div id="collapseSix" class="accordion-collapse collapse" aria-labelledby="headingSix" data-bs-parent="#formCAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-md-4"><label class="form-label">Steps Explained to Duty Officers?</label><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="qc_steps_explained" value="true"></div></div><div class="col-md-8"><label class="form-label">Please Explain the steps</label><input type="text" class="form-control" name="qc_steps_details"></div><div class="col-12"><label class="form-label">Drawing mismatches escalated to PM or Engr</label><input type="text" class="form-control" name="qc_drawing_mismatches"></div></div></div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSeven"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSeven" aria-expanded="false" aria-controls="collapseSeven">Section 7: Risks & Escalations</button></h2>
                    <div id="collapseSeven" class="accordion-collapse collapse" aria-labelledby="headingSeven" data-bs-parent="#formCAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-12"><label class="form-label">Delays flagged (reason)</label><textarea class="form-control" name="re_delays_flagged_reason" rows="2"></textarea></div><div class="col-12"><label class="form-label">Support needed from Engineer/PM</label><textarea class="form-control" name="re_support_needed" rows="2"></textarea></div></div></div></div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingNine"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNine" aria-expanded="false" aria-controls="collapseNine">Section 9: Summary & Action Points</button></h2>
                    <div id="collapseNine" class="accordion-collapse collapse" aria-labelledby="headingNine" data-bs-parent="#formCAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-md-6"><label class="form-label">Overall Site Health</label><select class="form-select" name="sa_overall_site_health"><option value="">Select...</option>{% for opt in overall_site_health_options %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select></div><div class="col-md-6"><label class="form-label">Responsible Person</label><input type="text" class="form-control" name="sa_responsible_person"></div><div class="col-md-6"><label class="form-label">Immediate Actions Required</label><textarea class="form-control" name="sa_immediate_actions" rows="2"></textarea></div><div class="col-md-6"><label class="form-label">Critical Actions(Required)</label><textarea class="form-control" name="sa_critical_actions" rows="2"></textarea></div><div class="col-md-6"><label class="form-label">Deadline for Action(Required)<span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="sa_action_deadline"  id="sa_action_deadline">
                    </div><div class="col-md-6"><label class="form-label">Approved drawings/NOCs for all projects?</label><select class="form-select" name="sa_approved_drawings_check"><option value="">Select...</option>{% for opt in yes_no_help_options %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select></div><div class="col-12"><label class="form-label">If Help Required, Please mention</label><input type="text" class="form-control" name="sa_drawing_help_details"></div></div></div></div>
                </div>

            </div>
            <div class="mt-4 text-end">
                <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    Submit Daily Report
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
    // Helper function to read a cookie by name
   

    document.addEventListener('DOMContentLoaded', function () {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("sa_action_deadline").value = today;
        // --- UPDATED VIDEO RECORDER LOGIC with Camera Toggling ---
        const recordBtn = document.getElementById('record-btn');
        const stopBtn = document.getElementById('stop-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const videoPreview = document.getElementById('video-preview');
        const videoStatus = document.getElementById('video-status');
        const hiddenVideoIdInput = document.getElementById('toolbox_video_id');

        let mediaRecorder;
        let recordedChunks = [];
        let videoStream;
        // NEW: State variable to track the current camera facing mode
        let currentFacingMode = 'user'; // Start with the front camera

        async function checkCameraSupport() {
             try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) { return; }
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                // Show switch button only if there's more than one camera
                if (videoDevices.length > 1) { 
                    switchCameraBtn.style.display = 'inline-block'; 
                }
            } catch (e) { console.error("Could not enumerate devices:", e); }
        }

        async function startRecording() {
            try {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                }

                // NEW: Use facingMode to select front/back camera
                const constraints = { 
                    audio: true, 
                    video: { 
                        facingMode: { exact: currentFacingMode },
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 } 
                    } 
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                // --- ADD THIS LINE ---
                // Now that we have permission, check for other cameras.
                checkCameraSupport();
                // ---------------------
                videoPreview.srcObject = videoStream;
                mediaRecorder = new MediaRecorder(videoStream, { mimeType: 'video/webm' });
                recordedChunks = [];
                mediaRecorder.ondataavailable = event => { if (event.data.size > 0) recordedChunks.push(event.data); };
                mediaRecorder.onstop = uploadVideo;
                mediaRecorder.start();

                videoStatus.textContent = 'ðŸ”´ Recording...';
                recordBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                retakeBtn.style.display = 'none';
                switchCameraBtn.disabled = false;
            } catch (error) {
                console.error('Error accessing media devices.', error);
                videoStatus.textContent = 'Could not access camera/microphone.';
                alert(`Error: Could not access camera (${currentFacingMode} view). Please check browser permissions or try switching cameras.`);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                videoStream.getTracks().forEach(track => track.stop());
                videoStatus.textContent = 'Recording stopped. Preparing for upload...';
                stopBtn.disabled = true;
                switchCameraBtn.disabled = true;
            }
        }

        async function uploadVideo() {
           

            const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
            videoPreview.srcObject = null;
            videoPreview.src = URL.createObjectURL(videoBlob);
            videoPreview.muted = false;
            videoPreview.controls = true;
            videoStatus.innerHTML = `<div class="progress" role="progressbar"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">Uploading...</div></div>`;
            
            const formData = new FormData();
            formData.append('video', videoBlob, 'toolbox-talk.webm');
            
            try {
                const response = await fetchWithAuth('/uploads/api/videos/upload', { 
                    method: 'POST', 
                   // headers: { 'Authorization': `Bearer ${token}` },
                    body: formData 
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Upload failed');
                hiddenVideoIdInput.value = result.video_id;
                videoStatus.textContent = `âœ… Upload complete!`;
                recordBtn.style.display = 'none';
                stopBtn.style.display = 'none';
                switchCameraBtn.style.display = 'none';
                retakeBtn.style.display = 'inline-block';
            } catch (error) {
                videoStatus.textContent = `âŒ Upload failed: ${error.message}`;
                retakeBtn.style.display = 'inline-block';
            } finally {
                stopBtn.disabled = false;
            }
        }

        function resetVideo() {
            recordedChunks = [];
            if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); }
            videoPreview.srcObject = null;
            videoPreview.src = '';
            videoPreview.controls = false;
            videoPreview.muted = true;
            hiddenVideoIdInput.value = '';
            videoStatus.textContent = '';
            recordBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            retakeBtn.style.display = 'none';
            checkCameraSupport();
        }
        
        // NEW: Rewritten switchCamera function
        function switchCamera() {
            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
            startRecording();
        }

        recordBtn.addEventListener('click', () => startRecording());
        stopBtn.addEventListener('click', stopRecording);
        retakeBtn.addEventListener('click', resetVideo);
        switchCameraBtn.addEventListener('click', switchCamera);
        //checkCameraSupport();

        // --- IMAGE UPLOADER LOGIC (Unchanged) ---
        const imageUploadInput = document.getElementById('image-upload-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const hiddenImageIdsInput = document.getElementById('site_image_ids');

        imageUploadInput.addEventListener('change', function(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            

            imagePreviewContainer.innerHTML = '';
            let uploadedImageIds = [];
            hiddenImageIdsInput.value = '';

            Array.from(files).forEach(file => {
                const previewWrapper = document.createElement('div');
                previewWrapper.className = 'img-preview-wrapper';
                const img = document.createElement('img');
                img.className = 'img-preview';
                const progressOverlay = document.createElement('div');
                progressOverlay.className = 'upload-progress';
                progressOverlay.innerHTML = `<div class="spinner-border spinner-border-sm text-light" role="status"></div>`;
                previewWrapper.appendChild(img);
                previewWrapper.appendChild(progressOverlay);
                imagePreviewContainer.appendChild(previewWrapper);
                
                const reader = new FileReader();
                reader.onload = e => { img.src = e.target.result; }
                reader.readAsDataURL(file);

                const formData = new FormData();
                formData.append('files', file);

                fetchWithAuth('/uploads/api/images/upload', { 
                    method: 'POST', 
                    //headers: { 'Authorization': `Bearer ${token}` },
                    body: formData 
                })
                .then(response => {
                    if (!response.ok) { return response.json().then(err => { throw new Error(err.detail || 'Upload failed') }); }
                    return response.json();
                })
                .then(result => {
                    if (result.image_ids && result.image_ids.length > 0) {
                        uploadedImageIds.push(result.image_ids[0]);
                        hiddenImageIdsInput.value = uploadedImageIds.join(',');
                        progressOverlay.innerHTML = `<i class="bi bi-check-circle-fill text-success fs-4"></i>`;
                    } else { throw new Error('No image ID returned'); }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    progressOverlay.innerHTML = `<i class="bi bi-x-circle-fill text-danger fs-4"></i>`;
                });
            });
        });
        
        // --- MAIN FORM LOGIC (Unchanged) ---
        const formSelects = document.querySelectorAll('#site-officer-form select');
        formSelects.forEach(select => { new Choices(select, { searchEnabled: true, removeItemButton: false, itemSelectText: '', allowHTML: false }); });
        
        const form = document.getElementById('site-officer-form');
        const submitBtn = document.getElementById('submit-btn');
        const spinner = submitBtn.querySelector('.spinner-border');
        const toastElement = document.getElementById('responseToast');
        const toast = new bootstrap.Toast(toastElement);

        document.querySelector('input[name="date"]').valueAsDate = new Date();

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
            
            spinner.style.display = 'inline-block';
            submitBtn.disabled = true;

            const toastBody = document.getElementById('toast-body');
            const toastTitle = document.getElementById('toast-title');
            toastElement.classList.remove('bg-danger', 'bg-success');
            
            

            const formData = new FormData(form);
            try {
                const response = await fetchWithAuth('/reports/site-officer-reports/', { 
                    method: 'POST', 
                    //headers: { 'Authorization': `Bearer ${token}` },
                    body: formData 
                });

                const result = await response.json();
                if (response.status === 401) { throw new Error(result.detail || 'Session expired.'); }
                if (!response.ok) { throw new Error(result.message || result.detail || 'An unknown error occurred.'); }

                toastElement.classList.add('bg-success', 'text-white');
                toastTitle.innerText = 'Success!';
                toastBody.innerText = result.message;
                form.reset();
                form.classList.remove('was-validated');
                resetVideo(); 
                imagePreviewContainer.innerHTML = '';
                window.scrollTo(0, 0); 
                document.querySelector('input[name="date"]').valueAsDate = new Date();

            } catch (error) {
                toastElement.classList.add('bg-danger', 'text-white');
                toastTitle.innerText = 'Error!';
                document.getElementById('toast-body').innerText = error.message;
                window.scrollTo(0, 0); 
            } finally {
                toast.show();
                spinner.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}
