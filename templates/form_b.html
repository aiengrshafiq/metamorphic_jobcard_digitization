{% extends "base.html" %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<style>
    .choices__inner { background-color: var(--bs-body-bg); border-radius: var(--bs-border-radius); border: var(--bs-border-width) solid var(--bs-border-color); }
    .choices[data-type*="select-one"]::after { border-color: var(--bs-body-color) transparent transparent; }
    .choices__list--dropdown .choices__item--selectable.is-highlighted { background-color: #0d6efd !important; }
    #form-b-sections { display: none; }
    .accordion-button:not(.collapsed) { color: var(--bs-primary-color-rgb); background-color: var(--bs-primary-bg-subtle); }
    #video-recorder video { max-width: 100%; border-radius: .375rem; background-color: #000; }
    /* NEW STYLES for Image Uploader */
    #image-preview-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
    .img-preview-wrapper { position: relative; width: 120px; height: 120px; }
    .img-preview { width: 100%; height: 100%; object-fit: cover; border-radius: .375rem; border: 1px solid #dee2e6; }
    .upload-progress { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; border-radius: .375rem; }
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-body p-4">
        <form id="duty-officer-form" novalidate>
            <input type="hidden" name="toolbox_video_id" id="toolbox_video_id">
            <input type="hidden" name="site_image_ids" id="site_image_ids">

            <div class="mb-3">
                <label for="job_card_id" class="form-label fs-5">First, select the Job Card you are reporting progress for:</label>
                <select class="form-select" id="job_card_id" name="job_card_id" required>
                    <option value="">Search by Job Card No. or Project Name...</option>
                    {% for jc in job_cards %}
                    <option value="{{ jc.id }}">{{ jc.job_card_no }} ({{ jc.project.name }})</option>
                    {% endfor %}
                </select>
            </div>

            <div id="form-b-sections">
                <hr class="my-4">

                <div id="video-recorder" class="mb-4">
                    <h4 class="mb-3">Toolbox Video (Optional)</h4>
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <video id="video-preview" class="w-100" playsinline autoplay muted></video>
                            <div id="video-status" class="mt-2 text-muted"></div>
                            <div id="video-controls" class="mt-3 d-flex justify-content-center gap-2">
                                <button type="button" class="btn btn-danger" id="record-btn"><i class="bi bi-record-circle me-1"></i> Start</button>
                                <button type="button" class="btn btn-secondary" id="stop-btn" style="display: none;"><i class="bi bi-stop-circle me-1"></i> Stop</button>
                                <button type="button" class="btn btn-outline-secondary" id="switch-camera-btn" style="display: none;" title="Switch Camera"><i class="bi bi-camera-video-reverse"></i>Switch Camera</button>
                                <button type="button" class="btn btn-info text-white" id="retake-btn" style="display: none;"><i class="bi bi-arrow-counterclockwise me-1"></i> Retake</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h4 class="mb-3">Site Images (Optional)</h4>
                     <div class="card border-0 shadow-sm">
                         <div class="card-body">
                             <label for="image-upload-input" class="form-label">Select one or more images to upload:</label>
                             <input class="form-control" type="file" id="image-upload-input" accept="image/*" multiple>
                             <div id="image-preview-container"></div>
                         </div>
                     </div>
                </div>

                <div class="accordion" id="formBAccordion">
                     <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">Section 1: Progress Details</button></h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#formBAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-md-6"><label for="task_id" class="form-label">Task Description <span class="text-danger">*</span></label><select class="form-select" id="task_id" name="task_id" required><option value="">Select a task...</option></select></div><div class="col-md-6"><label for="date_of_work" class="form-label">Date (of work) <span class="text-danger">*</span></label><input type="date" class="form-control" id="date_of_work" name="date_of_work" required></div><div class="col-12"><label for="actual_output" class="form-label">Actual Output for the Day <span class="text-danger">*</span></label><textarea class="form-control" id="actual_output" name="actual_output" rows="3" required></textarea></div><div class="col-12"><label for="issues_delays" class="form-label">Issues / Delays <span class="text-danger">*</span></label><textarea class="form-control" id="issues_delays" name="issues_delays" rows="3" required></textarea></div></div></div></div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">Section 2: Toolbox Talk</button></h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#formBAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-md-12"><label class="form-label">Attendance (Names) <span class="text-danger">*</span></label><input type="text" class="form-control" name="tbt_attendance" required></div><div class="col-md-12"><label class="form-label">Topic Discussed</label><input type="text" class="form-control" name="tbt_topic_discussed"></div><div class="col-md-12"><label class="form-label">Key Points <span class="text-danger">*</span></label><textarea class="form-control" name="tbt_key_points" rows="3" required></textarea></div></div></div></div>
                    </div>
                    <div class="accordion-item">
                         <h2 class="accordion-header" id="headingThree"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">Section 3: Site Management</button></h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#formBAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-md-6"><label class="form-label">Equipment Inventory <span class="text-danger">*</span></label><input type="text" class="form-control" name="sm_equipment_inventory" required></div><div class="col-md-6"><label class="form-label">Equipment Condition</label><select class="form-select" name="sm_equipment_condition"><option value="">Select...</option>{% for opt in equipment_conditions %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select></div><div class="col-12"><label class="form-label">Equipment Transfer (Mention Meta Code and Site Officer Name)</label><input type="text" class="form-control" name="sm_equipment_transfer"></div><div class="col-12"><label class="form-label">Remarks</label><textarea class="form-control" name="sm_remarks" rows="2"></textarea></div><div class="col-md-6"><label class="form-label">Subcontractor Coordination</label><select class="form-select" name="sm_sub_contractor_coordination"><option value="">Select...</option>{% for opt in sub_contractor_coordinations %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select></div><div class="col-md-6"><label class="form-label">If Issues, please Mention</label><input type="text" class="form-control" name="sm_coordination_issues"></div><div class="col-md-6"><label class="form-label">Safety Hazards Identified <span class="text-danger">*</span></label><input type="text" class="form-control" name="sm_safety_hazards" required></div>
                        <div class="col-md-6">
                        <label class="form-label">Officer and Duty Officer (Signature) <span class="text-danger">*</span></label>
                        
                        <select class="form-select" name="foreman_user_id" required>
                            <option value="">Select...</option>
                            {% for f in foremen %}
                            <option value="{{ f.id }}">{{ f.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                        <div class="col-md-6"><label class="form-label">PPE Check</label><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="sm_ppe_check" value="true"></div></div><div class="col-md-6"><label class="form-label">Photos / Evidence Submit on WhatsApp</label><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="sm_photos_on_whatsapp" value="true"></div></div></div></div></div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFour"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">Section 4: Material Management</button></h2>
                        <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#formBAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-md-6"><label class="form-label">Deliveries Received <span class="text-danger">*</span></label><select class="form-select" name="mm_deliveries_received" required><option value="">Select...</option>{% for opt in delivery_statuses %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select></div><div class="col-md-6"><label class="form-label">If Rejected, please mention reason</label><input type="text" class="form-control" name="mm_rejection_reason"></div><div class="col-md-6"><label class="form-label">Stock Balance (Materials) Mention Quantity <span class="text-danger">*</span></label><input type="text" class="form-control" name="mm_stock_balance" required></div><div class="col-md-6"><label class="form-label">Material Transfers made (Project Code & Site Officer)</label><input type="text" class="form-control" name="mm_material_transfers"></div></div></div></div>
                    </div>
                     <div class="accordion-item">
                         <h2 class="accordion-header" id="headingFive"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">Section 5: Knowledge and Training Transfer</button></h2>
                        <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#formBAccordion"><div class="accordion-body"><div class="row g-3"><div class="col-md-6"><label class="form-label">SOPs Explain by Site officers or Engr</label><select class="form-select" name="kt_sops_explained"><option value="">Select...</option>{% for opt in sop_statuses %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}</select></div><div class="col-md-6"><label class="form-label">If required, please mention work</label><input type="text" class="form-control" name="kt_help_required_details"></div><div class="col-12"><label class="form-label">Critical actions/ Materials Required</label><input type="text" class="form-control" name="kt_critical_actions_required"></div></div></div></div>
                    </div>
                </div>

                <div class="mt-4 text-end">
                    <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                        Submit Progress Report
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
    

    document.addEventListener('DOMContentLoaded', function() {
        // --- UPDATED VIDEO RECORDER LOGIC with Camera Toggling ---
        const recordBtn = document.getElementById('record-btn');
        const stopBtn = document.getElementById('stop-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const videoPreview = document.getElementById('video-preview');
        const videoStatus = document.getElementById('video-status');
        const hiddenVideoIdInput = document.getElementById('toolbox_video_id');

        let mediaRecorder;
        let recordedChunks = [];
        let videoStream;
        // NEW: State variable to track the current camera facing mode
        let currentFacingMode = 'user'; // Start with the front camera

        async function checkCameraSupport() {
             try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) { return; }
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                // Show switch button only if there's more than one camera
                if (videoDevices.length > 1) { 
                    switchCameraBtn.style.display = 'inline-block'; 
                }
            } catch (e) { console.error("Could not enumerate devices:", e); }
        }

        async function startRecording() {
            try {
                // Stop any existing stream before starting a new one
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                }

                // NEW: Use facingMode to select front/back camera
                const constraints = { 
                    audio: true, 
                    video: { 
                        facingMode: { exact: currentFacingMode },
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 } 
                    } 
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                // --- ADD THIS LINE ---
                // Now that we have permission, check for other cameras.
                checkCameraSupport();
                // ---------------------
                videoPreview.srcObject = videoStream;
                mediaRecorder = new MediaRecorder(videoStream, { mimeType: 'video/webm' });
                recordedChunks = [];
                mediaRecorder.ondataavailable = event => { if (event.data.size > 0) recordedChunks.push(event.data); };
                mediaRecorder.onstop = uploadVideo;
                mediaRecorder.start();

                videoStatus.textContent = 'ðŸ”´ Recording...';
                recordBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                retakeBtn.style.display = 'none';
                switchCameraBtn.disabled = false; // Re-enable switch button
            } catch (error) {
                console.error('Error accessing media devices.', error);
                videoStatus.textContent = 'Could not access camera/microphone.';
                alert(`Error: Could not access camera (${currentFacingMode} view). Please check browser permissions or try switching cameras.`);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                videoStream.getTracks().forEach(track => track.stop());
                videoStatus.textContent = 'Recording stopped. Preparing for upload...';
                stopBtn.disabled = true;
                switchCameraBtn.disabled = true; // Disable during upload
            }
        }

        async function uploadVideo() {
           

            const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
            videoPreview.srcObject = null;
            videoPreview.src = URL.createObjectURL(videoBlob);
            videoPreview.muted = false;
            videoPreview.controls = true;
            videoStatus.innerHTML = `<div class="progress" role="progressbar"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">Uploading...</div></div>`;
            
            const formData = new FormData();
            formData.append('video', videoBlob, 'toolbox-talk.webm');
            
            try {
                const response = await fetchWithAuth('/uploads/api/videos/upload', { 
                    method: 'POST', 
                    //headers: { 'Authorization': `Bearer ${token}` },
                    body: formData 
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Upload failed');
                hiddenVideoIdInput.value = result.video_id;
                videoStatus.textContent = `âœ… Upload complete!`;
                recordBtn.style.display = 'none';
                stopBtn.style.display = 'none';
                switchCameraBtn.style.display = 'none';
                retakeBtn.style.display = 'inline-block';
            } catch (error) {
                videoStatus.textContent = `âŒ Upload failed: ${error.message}`;
                retakeBtn.style.display = 'inline-block';
            } finally {
                stopBtn.disabled = false;
            }
        }

        function resetVideo() {
            recordedChunks = [];
            if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); }
            videoPreview.srcObject = null;
            videoPreview.src = '';
            videoPreview.controls = false;
            videoPreview.muted = true;
            hiddenVideoIdInput.value = '';
            videoStatus.textContent = '';
            recordBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            retakeBtn.style.display = 'none';
            checkCameraSupport(); // Re-check to show switch button if available
        }
        
        // NEW: Rewritten switchCamera function
        function switchCamera() {
            // Toggle between 'user' (front) and 'environment' (back)
            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
            // Restart the recording with the new facing mode
            startRecording();
        }

        recordBtn.addEventListener('click', () => startRecording());
        stopBtn.addEventListener('click', stopRecording);
        retakeBtn.addEventListener('click', resetVideo);
        switchCameraBtn.addEventListener('click', switchCamera);
        //checkCameraSupport(); // Check for cameras on page load

        // --- IMAGE UPLOADER LOGIC (Unchanged) ---
        const imageUploadInput = document.getElementById('image-upload-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const hiddenImageIdsInput = document.getElementById('site_image_ids');

        imageUploadInput.addEventListener('change', function(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            imagePreviewContainer.innerHTML = '';
            let uploadedImageIds = [];
            hiddenImageIdsInput.value = '';
            Array.from(files).forEach(file => {
                const previewWrapper = document.createElement('div');
                previewWrapper.className = 'img-preview-wrapper';
                const img = document.createElement('img');
                img.className = 'img-preview';
                const progressOverlay = document.createElement('div');
                progressOverlay.className = 'upload-progress';
                progressOverlay.innerHTML = `<div class="spinner-border spinner-border-sm text-light" role="status"></div>`;
                previewWrapper.appendChild(img);
                previewWrapper.appendChild(progressOverlay);
                imagePreviewContainer.appendChild(previewWrapper);
                const reader = new FileReader();
                reader.onload = e => { img.src = e.target.result; }
                reader.readAsDataURL(file);
                const formData = new FormData();
                formData.append('files', file);
                fetchWithAuth('/uploads/api/images/upload', { 
                    method: 'POST', 
                    //headers: { 'Authorization': `Bearer ${token}` },
                    body: formData 
                })
                .then(response => {
                    if (!response.ok) { return response.json().then(err => { throw new Error(err.detail || 'Upload failed') }); }
                    return response.json();
                })
                .then(result => {
                    if (result.image_ids && result.image_ids.length > 0) {
                        uploadedImageIds.push(result.image_ids[0]);
                        hiddenImageIdsInput.value = uploadedImageIds.join(',');
                        progressOverlay.innerHTML = `<i class="bi bi-check-circle-fill text-success fs-4"></i>`;
                    } else { throw new Error('No image ID returned'); }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    progressOverlay.innerHTML = `<i class="bi bi-x-circle-fill text-danger fs-4"></i>`;
                });
            });
        });
        
        // --- MAIN FORM LOGIC (Unchanged) ---
        const jobCardSelect = document.getElementById('job_card_id');
        const formBSections = document.getElementById('form-b-sections');
        const taskSelect = document.getElementById('task_id');
        const jobCardChoices = new Choices(jobCardSelect, { searchEnabled: true, removeItemButton: false, itemSelectText: '' });
        let taskChoices;

        jobCardSelect.addEventListener('change', async function() {
            const jobCardId = this.value;
            taskSelect.innerHTML = '<option value="">Loading tasks...</option>';
            if (taskChoices) { taskChoices.destroy(); }
            
            if (jobCardId) {
                formBSections.style.display = 'block';
                const token = getCookie('access_token');
                if (!token) {
                    taskSelect.innerHTML = '<option value="">Authentication error</option>';
                    return;
                }
                try {
                    const response = await fetchWithAuth(`/job-cards/api/job-cards/${jobCardId}/tasks`, {
                       // headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Could not fetch tasks.');
                   const tasks = await response.json();
                        let options = '<option value="">Select a task...</option>';
                        tasks.forEach(task => {
                            // Build a more descriptive label
                            let displayText = task.task_details;
                            if (task.quantity && task.units) {
                                displayText += ` (${task.quantity} ${task.units})`;
                            }
                            options += `<option value="${task.id}">${displayText}</option>`; 
                        });
                        taskSelect.innerHTML = options;
                        console.log('Tasks Options loaded:', options);
                } catch (error) {
                    taskSelect.innerHTML = '<option value="">Could not load tasks</option>';
                }
            } else {
                formBSections.style.display = 'none';
                taskSelect.innerHTML = '<option value="">Select a task...</option>';
            }
            taskChoices = new Choices(taskSelect, { searchEnabled: false });
        });

        const form = document.getElementById('duty-officer-form');
        const submitBtn = document.getElementById('submit-btn');
        const spinner = submitBtn.querySelector('.spinner-border');
        const toastElement = document.getElementById('responseToast');
        const toast = new bootstrap.Toast(toastElement);

        document.getElementById('date_of_work').valueAsDate = new Date();

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
            spinner.style.display = 'inline-block';
            submitBtn.disabled = true;

            const toastBody = document.getElementById('toast-body');
            const toastTitle = document.getElementById('toast-title');
            toastElement.classList.remove('bg-danger', 'bg-success');
            
            

            const formData = new FormData(form);
            try {
                const response = await fetchWithAuth('/reports/duty-officer-progress/', { 
                    method: 'POST', 
                   // headers: { 'Authorization': `Bearer ${token}` },
                    body: formData 
                });

                const result = await response.json();
                if (response.status === 401) { throw new Error(result.detail || 'Session expired.'); }
                if (!response.ok) { throw new Error(result.message || result.detail || 'An unknown error occurred.'); }
                
                toastElement.classList.add('bg-success', 'text-white');
                toastTitle.innerText = 'Success!';
                toastBody.innerText = result.message;
                form.reset();
                jobCardChoices.clearStore();
                jobCardChoices.setChoiceByValue('');
                formBSections.style.display = 'none';
                resetVideo();
                imagePreviewContainer.innerHTML = '';
                document.getElementById('date_of_work').valueAsDate = new Date();

            } catch (error) {
                toastElement.classList.add('bg-danger', 'text-white');
                toastTitle.innerText = 'Error!';
                toastBody.innerText = error.message;
            } finally {
                toast.show();
                spinner.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}