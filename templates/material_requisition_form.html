{% extends "base.html" %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<style>
    .choices__inner { background-color: var(--bs-body-bg); border-radius: var(--bs-border-radius); border: var(--bs-border-width) solid var(--bs-border-color); }
    .choices__input { background-color: transparent !important; color: var(--bs-body-color); }
    .choices[data-type*="select-one"]::after { border-color: var(--bs-body-color) transparent transparent; }
    .choices__list--dropdown .choices__item--selectable.is-highlighted { background-color: #0d6efd !important; }
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-body p-4">
        <form id="material-requisition-form" novalidate>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Request Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" name="request_date" required>
                </div>
                 <div class="col-md-6">
                    <label class="form-label">Urgency <span class="text-danger">*</span></label>
                    <select class="form-select" id="urgency-select" name="urgency" required>
                        <option value="">Select urgency...</option>
                        {% for level in urgency_levels %}
                        <option value="{{ level }}">{{ level }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Required Delivery Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="delivery-date-input" name="required_delivery_date" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Project Code <span class="text-danger">*</span></label>
                    <select class="form-select" id="project_id" name="project_id" required>
                        <option value="">Select a project...</option>
                        {% for p in projects %}
                        <option value="{{ p.id }}">{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6" id="job-cards-wrapper" style="display: none;">
                    <label class="form-label">Related Job Cards (Optional)</label>
                    <select class="form-select" id="job_card_ids" name="job_card_ids" multiple>
                        </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Requested By <span class="text-danger">*</span></label>
                    <select class="form-select" name="requested_by_id" required>
                        <option value="">Select a person...</option>
                        {% for requester in supervisors %}
                        <option value="{{ requester.id }}" {% if requester.id == user.id %}selected{% endif %}>{{ requester.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Material Type <span class="text-danger">*</span></label>
                    <select class="form-select" name="material_type" required>
                        <option value="">Select type...</option>
                        {% for type in material_types %}
                        <option value="{{ type }}">{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
               
                <div class="col-12">
                    <label class="form-label">Material List</label>
                    <textarea class="form-control" name="special_notes" rows="3" placeholder="Write materials here if you can not find in below list and save as Draft"></textarea>
                </div>
                <!-- <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">Materials & Quantities <span class="text-danger">*</span></label>
                    <button type="button" class="btn btn-success btn-sm" id="add-item-btn">
                        <i class="bi bi-plus-circle me-1"></i> Add Item
                    </button>
                </div>
                <div id="line-items-container">
                    </div>
            </div> -->
            </div>

            <div class="mt-4 text-end">
                <button type="button" class="btn btn-primary btn-lg" id="draft-btn">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    Save as Draft
                     
                </button>
                <!-- <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    Submit Request
                </button> -->
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
    

    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. INITIAL SETUP ---
        const choicesInstances = {};
        // Initialize Choices.js on the static dropdowns that exist on page load
        document.querySelectorAll('#material-requisition-form select:not([multiple])').forEach(select => {
            choicesInstances[select.name] = new Choices(select, { searchEnabled: true, removeItemButton: false, itemSelectText: '' });
        });

        // --- NEW: Date Logic Elements ---
        // --- NEW: Date Logic Elements ---
        const urgencySelect = document.getElementById('urgency-select');
        const deliveryDateInput = document.getElementById('delivery-date-input');

        // Helper to format a Date object into YYYY-MM-DD
        function toYYYYMMDD(date) {
            return date.toISOString().split('T')[0];
        }

        function updateDeliveryDateRules() {
            const urgency = urgencySelect.value;
            if (!urgency) return;

            // --- THIS IS THE CORRECTED TIME LOGIC ---
            // Get the current date
            const now = new Date();
            
            // Get the current hour in UTC, then add 4 for GST (UTC+4)
            // The modulo % 24 handles wraparound (e.g., 22:00 UTC + 4 hours = 02:00 GST next day)
            const gstHour = (now.getUTCHours() + 4) % 24;
            
            // Use a new date object for calculations to not affect the original 'now'
            let minDate = new Date(); 
            // ------------------------------------------
            
            if (urgency === 'Critical') {
                if (gstHour >= 9) { // After 9 AM GST
                    minDate.setDate(minDate.getDate() + 1); // Minimum is tomorrow
                }
                // If before 9 AM, minimum is today, which is the default for 'minDate'.
                deliveryDateInput.min = toYYYYMMDD(minDate);
                deliveryDateInput.value = toYYYYMMDD(minDate);
            } else if (urgency === 'Normal' || urgency === 'Urgent') {
                let daysToAdd = 3;
                if (gstHour >= 9) { // After 9 AM GST
                    minDate.setDate(minDate.getDate() + 1); // Start counting from tomorrow
                }
                minDate.setDate(minDate.getDate() + (daysToAdd - 1)); // Add the remaining days
                deliveryDateInput.min = toYYYYMMDD(minDate);
                deliveryDateInput.value = toYYYYMMDD(minDate);
            }
        }
        
        // Add event listener to the urgency dropdown
        urgencySelect.addEventListener('change', updateDeliveryDateRules);
        // Initialize once on page load in case a value is already selected
        updateDeliveryDateRules();
        // --- END OF NEW DATE LOGIC ---

        const form = document.getElementById('material-requisition-form');
        const submitBtn = document.getElementById('submit-btn');
        const draftBtn = document.getElementById('draft-btn');
        //const spinner = submitBtn.querySelector('.spinner-border');
        const spinner = draftBtn.querySelector('.spinner-border');
        const toastElement = document.getElementById('responseToast');
       
        const toast = new bootstrap.Toast(toastElement);

        document.querySelector('input[name="request_date"]').valueAsDate = new Date();

        // --- 2. DYNAMIC JOB CARD DROPDOWN LOGIC ---
        const projectSelect = document.getElementById('project_id');
        const jobCardsWrapper = document.getElementById('job-cards-wrapper');
        const jobCardsSelect = document.getElementById('job_card_ids');
        let jobCardChoices;

        projectSelect.addEventListener('change', async function() {
            const projectId = this.value;
            if (!projectId) {
                jobCardsWrapper.style.display = 'none';
                if (jobCardChoices) jobCardChoices.clearStore();
                return;
            }
            jobCardsWrapper.style.display = 'block';
            if (jobCardChoices) {
                jobCardChoices.clearStore();
                jobCardChoices.setChoices([{ value: '', label: 'Loading...', disabled: true }]);
            } else {
                 jobCardsSelect.innerHTML = '<option value="">Loading...</option>';
            }
            
            try {
                const response = await fetch(`/job-cards/by-project/${projectId}`);
                if (!response.ok) throw new Error('Failed to fetch job cards.');
                const jobCards = await response.json();
                const choices = jobCards.map(jc => ({ value: jc.id, label: jc.job_card_no }));
                
                if (jobCardChoices) {
                    jobCardChoices.setChoices(choices, 'value', 'label', true);
                } else {
                    jobCardChoices = new Choices(jobCardsSelect, { removeItemButton: true, choices: choices });
                }
            } catch (error) {
                console.error(error);
                if (jobCardChoices) jobCardChoices.clearStore();
            }
        });

        // --- 3. DYNAMIC MATERIAL LINE ITEMS LOGIC ---
        const lineItemsContainer = document.getElementById('line-items-container');
        const addItemBtn = document.getElementById('add-item-btn');
        let itemCounter = 0;

        function createItemRow() {
            const itemRow = document.createElement('div');
            itemRow.className = 'row g-2 mb-2 align-items-center item-row';
            itemRow.innerHTML = `
                <div class="col-sm-7">
                    <select class="form-select" name="material_ids" required>
                        <option value="">Select a material...</option>
                        {% for material in materials %}
                        <option value="{{ material.id }}">{{ material.name }} ({{ material.unit }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-sm-4">
                    <input type="number" step="0.01" class="form-control" name="quantities" placeholder="Quantity" required>
                </div>
                <div class="col-sm-1 text-end">
                    <button type="button" class="btn btn-danger btn-sm remove-item-btn" title="Remove Item">&times;</button>
                </div>
            `;
            lineItemsContainer.appendChild(itemRow);
            new Choices(itemRow.querySelector('select'), { searchEnabled: true, removeItemButton: false, itemSelectText: '' });
        }

        //addItemBtn.addEventListener('click', createItemRow);
        
        // lineItemsContainer.addEventListener('click', function(e) {
        //     if (e.target && e.target.classList.contains('remove-item-btn')) {
        //         e.target.closest('.item-row').remove();
        //     }
        // });
        
        // Add one line item row to start with
        //createItemRow();

        // --- 4. FORM SUBMISSION LOGIC ---
        // --- UPDATE EVENT LISTENERS ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            handleFormSubmit('submit_request');
        });

        draftBtn.addEventListener('click', function() {
            handleFormSubmit('save_draft');
        });
        
    async function handleFormSubmit(action) {
        // For final submission, validate the form. For drafts, don't.
        if (action === 'submit_request' && !form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        spinner.style.display = 'inline-block';
        //submitBtn.disabled = true;
        draftBtn.disabled = true;

        const formData = new FormData(form);
        formData.append('submit_action', action); // Add which button was clicked

            

        const toastBody = document.getElementById('toast-body');
        const toastTitle = document.getElementById('toast-title');
        toastElement.classList.remove('bg-danger', 'bg-success');

        try {
            const response = await fetchWithAuth('/procurement/material-requisitions/', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (!response.ok) { throw new Error(result.detail || 'An error occurred.'); }

            // ... (your existing success toast logic)
            toastElement.classList.add('bg-success', 'text-white');
            toastTitle.innerText = 'Success!';
            toastBody.innerText = result.message;

            // Redirect to the appropriate list page
            setTimeout(() => {
                window.location.href = action === 'save_draft' ? '/procurement/material-requisitions-drafts' : '/procurement/material-requisitions';
            }, 1500);

        } catch (error) {
            // ... (your existing error toast logic)
            toastElement.classList.add('bg-danger', 'text-white');
            toastTitle.innerText = 'Error!';
            toastBody.innerText = error.message;
        } finally {
            spinner.style.display = 'none';
            //submitBtn.disabled = false;
            draftBtn.disabled = false;
        }
    }

        // form.addEventListener('submit', async function(e) {
        //     e.preventDefault();
        //     if (!form.checkValidity()) {
        //         form.classList.add('was-validated');
        //         return;
        //     }
        //     spinner.style.display = 'inline-block';
        //     submitBtn.disabled = true;

        //     const toastBody = document.getElementById('toast-body');
        //     const toastTitle = document.getElementById('toast-title');
        //     toastElement.classList.remove('bg-danger', 'bg-success');
            
           

        //     try {
        //         const response = await fetchWithAuth('/procurement/material-requisitions/', {
        //             method: 'POST',
                   
        //             body: new FormData(form)
        //         });
        //         const result = await response.json();
        //         if (!response.ok) { throw new Error(result.detail || result.message || 'An error occurred.'); }

        //         toastElement.classList.add('bg-success', 'text-white');
        //         toastTitle.innerText = 'Success!';
        //         toastBody.innerText = result.message;
                
        //         // Full form reset
        //         form.reset();
        //         form.classList.remove('was-validated');
        //         document.querySelector('input[name="request_date"]').valueAsDate = new Date();
        //         Object.values(choicesInstances).forEach(instance => instance.clearStore());
        //         if (jobCardChoices) jobCardChoices.clearStore();
        //         jobCardsWrapper.style.display = 'none';
        //         lineItemsContainer.innerHTML = '';
        //         createItemRow(); // Add back one empty row

        //     } catch (error) {
        //         toastElement.classList.add('bg-danger', 'text-white');
        //         toastTitle.innerText = 'Error!';
        //         toastBody.innerText = error.message;
        //     } finally {
        //         toast.show();
        //         spinner.style.display = 'none';
        //         submitBtn.disabled = false;
        //     }
        // });
    });
</script>
{% endblock %}
