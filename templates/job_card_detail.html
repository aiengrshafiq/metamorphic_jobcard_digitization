{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div id="loading-state" class="text-center">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="mt-2 text-muted">Loading job card details...</p>
    </div>

    <div id="content-container" style="display: none;">
        <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2 mb-0 text-truncate">{{ page_title }}</h1>
            {% if is_privileged %}
            <div class="btn-toolbar mb-2 mb-md-0">
                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#reassignModal">
                    <i class="bi bi-person-gear me-1"></i> Re-assign
                </button>
            </div>
            {% endif %}
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-list-task me-2"></i>Tasks</h5></div>
                    <div class="table-responsive">
                    <table class="table table-striped table-sm mb-0">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Task Details</th>
                                <th class="text-end">QTY</th>
                                <th>Units</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th class="text-end">Log</th> 
                            </tr>
                        </thead>
                        <tbody id="task-list-body">
                            </tbody>
                    </table>
                </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-chat-dots-fill me-2"></i>Comments</h5></div>
                    <div class="card-body">
                        <div id="comment-list" class="mb-3"></div>
                        <form id="comment-form">
                            <div class="mb-3">
                                <label for="comment-text" class="form-label">Add a new comment</label>
                                <textarea class="form-control" id="comment-text" name="comment_text" rows="3" required placeholder="Add a new comment..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary" id="submit-comment-btn">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                Post Comment
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header"><h5 class="mb-0">Job Card Info</h5></div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-12" id="jc-number"></dt>
                            <dd class="col-12" id="jc-project"></dd>
                            <dt class="col-sm-5 mt-2">Status</dt><dd class="col-sm-7 mt-2" id="jc-status"></dd>
                            <dt class="col-sm-5">Date Issued</dt><dd class="col-sm-7" id="jc-date-issued"></dd>
                            <dt class="col-sm-5">Site Location</dt><dd class="col-sm-7" id="jc-site-location"></dd>
                            <dt class="col-sm-5">Created By</dt><dd class="col-sm-7" id="jc-created-by"></dd>
                        </dl>
                    </div>
                </div>
                <div class="card shadow-sm mt-4">
                    <div class="card-header"><h5 class="mb-0">Assigned Personnel</h5></div>
                    <div class="card-body">
                         <dl class="row mb-0">
                            <dt class="col-sm-5">Site Engineer</dt><dd class="col-sm-7" id="jc-engineer"></dd>
                            <dt class="col-sm-5">Supervisor</dt><dd class="col-sm-7" id="jc-supervisor"></dd>
                            <dt class="col-sm-5">Foreman</dt><dd class="col-sm-7" id="jc-foreman"></dd>
                        </dl>
                    </div>
                </div>
                <div class="card shadow-sm mt-4">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Assignment History</h5></div>
                    <div class="card-body" id="assignment-history-container" style="max-height: 400px; overflow-y: auto;">
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reassignModal" tabindex="-1" aria-labelledby="reassignModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reassignModalLabel">Re-assign Job Card</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="reassign-form">
            <div class="mb-3">
                <label for="new_supervisor_id" class="form-label">New Supervisor / Site Officer</label>
                <select id="new_supervisor_id" class="form-select"></select>
            </div>
            <div class="mb-3">
                <label for="new_foreman_id" class="form-label">New Foreman / Duty Officer</label>
                <select id="new_foreman_id" class="form-select"></select>
            </div>
            <div class="mb-3">
                <label for="change_notes" class="form-label">Reason for Change (Optional)</label>
                <textarea id="change_notes" class="form-control" rows="3"></textarea>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-reassignment-btn">Save Changes</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="logProgressModal" tabindex="-1" aria-labelledby="logProgressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logProgressModalLabel">Log Progress for Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-5">
                        <form id="log-progress-form">
                            <input type="hidden" id="log-task-id">
                            <div class="mb-3">
                                <label for="log-date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="log-date" required>
                            </div>
                            <div class="mb-3">
                                <label for="log-quantity" class="form-label">Quantity Done</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="log-quantity" required>
                                    <span class="input-group-text" id="log-unit-display"></span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="log-notes" class="form-label">Notes (Optional)</label>
                                <textarea id="log-notes" class="form-control" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary" id="save-progress-btn">Log Progress</button>
                        </form>
                    </div>
                    <div class="col-md-7">
                        <h6>Task Summary</h6>
                        <dl class="row">
                            <dt class="col-sm-5">Total Qty:</dt>
                            <dd class="col-sm-7" id="summary-total-qty"></dd>
                            <dt class="col-sm-5">Total Done:</dt>
                            <dd class="col-sm-7" id="summary-total-done"></dd>
                            <dt class="col-sm-5">Remaining:</dt>
                            <dd class="col-sm-7" id="summary-remaining"></dd>
                        </dl>
                        <hr>
                        <h6>History</h6>
                        <div id="progress-history-list" style="max-height: 250px; overflow-y: auto;">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const jcId = {{ jc_id }};
    const loadingState = document.getElementById('loading-state');
    const contentContainer = document.getElementById('content-container');
    const commentList = document.getElementById('comment-list');
    const commentForm = document.getElementById('comment-form');
    const commentText = document.getElementById('comment-text');
    const taskTableBody = document.getElementById('task-list-body');
    const submitCommentBtn = document.getElementById('submit-comment-btn');
    const assignmentHistoryContainer = document.getElementById('assignment-history-container');
    const toastElement = document.getElementById('responseToast');
    const toast = new bootstrap.Toast(toastElement);

     // --- ADD THESE NEW CONSTANTS ---
    const logProgressModalEl = document.getElementById('logProgressModal');
    const logProgressModal = new bootstrap.Modal(logProgressModalEl);
    const logProgressForm = document.getElementById('log-progress-form');
    const saveProgressBtn = document.getElementById('save-progress-btn');
    const progressHistoryList = document.getElementById('progress-history-list');
    // -------------------------------

    // Modal elements
    const reassignModalEl = document.getElementById('reassignModal');
    const reassignModal = new bootstrap.Modal(reassignModalEl);
    const newSupervisorSelect = document.getElementById('new_supervisor_id');
    const newForemanSelect = document.getElementById('new_foreman_id');
    const changeNotesText = document.getElementById('change_notes');
    const saveReassignmentBtn = document.getElementById('save-reassignment-btn');

    // function getCookie(name) {
    //     const value = `; ${document.cookie}`;
    //     const parts = value.split(`; ${name}=`);
    //     if (parts.length === 2) return parts.pop().split(';').shift();
    // }

    function renderComments(comments) {
        commentList.innerHTML = '';
        if (comments && comments.length > 0) {
            comments.slice().reverse().forEach(comment => {
                const commentEl = document.createElement('div');
                commentEl.className = 'd-flex mb-3 border-bottom pb-2';
                const commentDate = new Date(comment.created_at).toLocaleString();
                commentEl.innerHTML = `
                    <div class="flex-shrink-0 me-3"><i class="bi bi-person-circle fs-3 text-secondary"></i></div>
                    <div class="flex-grow-1">
                        <h6 class="mt-0 mb-1">${comment.comment_by.name}</h6>
                        <p class="mb-1" style="white-space: pre-wrap;">${comment.comment_text}</p>
                        <small class="text-muted">${commentDate}</small>
                    </div>`;
                commentList.appendChild(commentEl);
            });
        } else {
            commentList.innerHTML = '<p class="text-muted text-center">No comments yet.</p>';
        }
    }

    function renderAssignmentHistory(logs) {
        assignmentHistoryContainer.innerHTML = '';
        if (logs && logs.length > 0) {
            logs.forEach(log => {
                const logEl = document.createElement('div');
                logEl.className = 'border-bottom pb-2 mb-2';
                const changeDate = new Date(log.created_at).toLocaleString();
                logEl.innerHTML = `
                    <small class="text-muted d-block">${changeDate}</small>
                    <p class="mb-1 small">
                        Assigned to <strong>${log.assigned_supervisor.name}</strong> (Sup) & <strong>${log.assigned_foreman.name}</strong> (For)
                        by <strong>${log.changed_by.name}</strong>.
                    </p>
                    ${log.change_notes ? `<small class="text-muted fst-italic">Note: ${log.change_notes}</small>` : ''}
                `;
                assignmentHistoryContainer.appendChild(logEl);
            });
        } else {
            assignmentHistoryContainer.innerHTML = '<p class="text-muted text-center small">No assignment changes have been logged.</p>';
        }
    }

    async function populatePersonnelDropdowns(currentSupervisorId, currentForemanId) {
        
        try {
            const response = await fetchWithAuth('/api/job-card-details/personnel', {
               // headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            newSupervisorSelect.innerHTML = '<option value="">Select Supervisor...</option>';
            data.supervisors.forEach(user => {
                const selected = user.id === currentSupervisorId ? 'selected' : '';
                newSupervisorSelect.innerHTML += `<option value="${user.id}" ${selected}>${user.name}</option>`;
            });
            newForemanSelect.innerHTML = '<option value="">Select Foreman...</option>';
            data.foremen.forEach(user => {
                const selected = user.id === currentForemanId ? 'selected' : '';
                newForemanSelect.innerHTML += `<option value="${user.id}" ${selected}>${user.name}</option>`;
            });
        } catch (error) { console.error("Failed to load personnel lists:", error); }
    }
    
    async function fetchJobCardDetails() {
       
        try {
            const response = await fetchWithAuth(`/api/job-card-details/${jcId}`, {
               // headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'Could not load details.');
            }
            const data = await response.json();
            
            document.getElementById('jc-number').textContent = data.job_card_no;
            document.getElementById('jc-project').textContent = data.project.name;
            document.getElementById('jc-status').innerHTML = `<span class="badge ${data.status === 'Done' ? 'bg-success' : 'bg-warning text-dark'}">${data.status}</span>`;
            document.getElementById('jc-date-issued').textContent = new Date(data.date_issued).toLocaleDateString();
            document.getElementById('jc-site-location').textContent = data.site_location;
            document.getElementById('jc-created-by').textContent = data.created_by ? data.created_by.name : 'N/A';
            document.getElementById('jc-engineer').textContent = data.site_engineer_user ? data.site_engineer_user.name : 'N/A';
            document.getElementById('jc-supervisor').textContent = data.supervisor_user ? data.supervisor_user.name : 'N/A';
            document.getElementById('jc-foreman').textContent = data.foreman_user ? data.foreman_user.name : 'N/A';

            // --- UPDATED: Populate Tasks Table ---
            taskTableBody.innerHTML = '';
            if (data.tasks && data.tasks.length > 0) {
                data.tasks.forEach(task => {
                    const row = document.createElement('tr');
                    
                    // Format dates safely, handling null values
                    const startDate = task.start_date ? new Date(task.start_date).toLocaleDateString() : 'N/A';
                    const endDate = task.end_date ? new Date(task.end_date).toLocaleDateString() : 'N/A';

                    row.innerHTML = `
                        <td>${task.task_details || ''}</td>
                        <td class="text-end">${task.quantity || ''}</td>
                        <td>${task.units || ''}</td>
                        <td>${startDate}</td>
                        <td>${endDate}</td>
                        <td><span class="badge bg-primary rounded-pill">${task.status}</span></td>
                        <td class="text-end"> <button class="btn btn-outline-success btn-sm log-progress-btn" data-bs-toggle="modal" data-bs-target="#logProgressModal" data-task-id="${task.id}" data-task-qty="${task.quantity}" data-task-unit="${task.units}">
                            <i class="bi bi-plus-lg"></i></button>
                       
                    </td>
                    `;
                    taskTableBody.appendChild(row);
                });
            } else {
                 taskTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No tasks found.</td></tr>';
            }
            // --- END OF UPDATE ---
            
            renderComments(data.comments);
            renderAssignmentHistory(data.assignment_logs);
            populatePersonnelDropdowns(data.supervisor_user_id, data.foreman_user_id);

            loadingState.style.display = 'none';
            contentContainer.style.display = 'block';

        } catch (error) {
            loadingState.innerHTML = `<p class="text-danger text-center">${error.message}</p>`;
        }
    }
    
    commentForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        
        const spinner = submitCommentBtn.querySelector('.spinner-border');
        submitCommentBtn.disabled = true;
        spinner.style.display = 'inline-block';
        try {
            const response = await fetchWithAuth(`/api/job-card-details/${jcId}/comments`, {
                method: 'POST',
                //headers: { 'Authorization': `Bearer ${token}` },
                body: new FormData(commentForm)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.detail || 'Failed to post comment.');
            fetchJobCardDetails();
            commentText.value = '';
        } catch (error) {
             // Show error toast
        } finally {
            submitCommentBtn.disabled = false;
            spinner.style.display = 'none';
        }
    });

    saveReassignmentBtn.addEventListener('click', async function() {
      
        const payload = {
            supervisor_user_id: parseInt(newSupervisorSelect.value),
            foreman_user_id: parseInt(newForemanSelect.value),
            notes: changeNotesText.value
        };
        try {
            const response = await fetchWithAuth(`/api/job-card-details/${jcId}/reassign`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.detail || 'Failed to re-assign.');
            reassignModal.hide();
            document.getElementById('toast-title').innerText = 'Success!';
            document.getElementById('toast-body').innerText = result.message;
            toastElement.className = 'toast bg-success text-white';
            toast.show();
            fetchJobCardDetails();
        } catch (error) {
            // Show error toast for reassignment failure
            alert(`Error: ${error.message}`); // Simple alert for now
        }
    });
    // --- ADD ALL THIS NEW LOGIC ---
    
    // Open the modal and fetch history
   
    // Handle the progress log form submission
  logProgressForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    saveProgressBtn.disabled = true;

    const taskId = document.getElementById('log-task-id').value;
    const payload = {
      date: document.getElementById('log-date').value,
      quantity_done: parseFloat(document.getElementById('log-quantity').value),
      notes: document.getElementById('log-notes').value,
    };

    try {
      const response = await fetchWithAuth(`/api/job-card-details/tasks/${taskId}/progress`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const result = await response.json();
      if (!response.ok) throw new Error(result.detail || 'Failed to save progress.');

      // Hide modal on success and refresh list
      logProgressModal.hide();
      fetchJobCardDetails();
    } catch (error) {
      alert(error.message);
    } finally {
      saveProgressBtn.disabled = false;
    }
  });

  // Fetch data when the modal is about to be shown
  logProgressModalEl.addEventListener('show.bs.modal', async function (event) {
    const button = event.relatedTarget;
    if (!button) return;

    const taskId = button.dataset.taskId;
    const taskQty = parseFloat(button.dataset.taskQty) || 0;
    const taskUnit = button.dataset.taskUnit || '';

    // 1. Set up form
    document.getElementById('log-task-id').value = taskId;
    document.getElementById('log-unit-display').textContent = taskUnit;
    document.getElementById('log-date').valueAsDate = new Date();
    document.getElementById('log-quantity').value = '';
    document.getElementById('log-notes').value = '';

    // 2. Show loading spinner
    progressHistoryList.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';

    try {
      // Fetch progress history
      const response = await fetchWithAuth(`/api/job-card-details/tasks/${taskId}/progress`);
      if (!response.ok) throw new Error('Could not load progress history.');
      const data = await response.json();

      // 3. Render summary
      const remaining = taskQty - data.total_done;
      document.getElementById('summary-total-qty').textContent = `${taskQty} ${taskUnit}`;
      document.getElementById('summary-total-done').textContent = `${data.total_done.toFixed(2)} ${taskUnit}`;
      document.getElementById('summary-remaining').textContent = `${remaining.toFixed(2)} ${taskUnit}`;

      // 4. Render history list
      if (!data.task || !data.task.progress_logs || data.task.progress_logs.length === 0) {
        progressHistoryList.innerHTML = '<p class="text-muted small">No progress logged yet.</p>';
      } else {
        progressHistoryList.innerHTML = ''; // Clear spinner
        data.task.progress_logs.forEach((log) => {
          const logEl = document.createElement('div');
          logEl.className = 'small border-bottom pb-1 mb-1';
          logEl.innerHTML = `
            <strong>${log.quantity_done} ${taskUnit}</strong> on ${new Date(log.date).toLocaleDateString()}
            <small class="d-block text-muted">by ${log.created_by.name} ${log.notes ? `- "${log.notes}"` : ''}</small>
          `;
          progressHistoryList.appendChild(logEl);
        });
      }
    } catch (error) {
      progressHistoryList.innerHTML = `<p class="text-danger small">${error.message}</p>`;
    }
  });
    

    
    // --- END OF NEW LOGIC ---
    fetchJobCardDetails();
});
</script>
{% endblock %}