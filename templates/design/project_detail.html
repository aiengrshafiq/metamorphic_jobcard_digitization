{% extends "base.html" %}

{% block content %}
<div id="loading-state" class="text-center mt-4">
    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
    <p class="mt-2 text-muted">Loading project details...</p>
</div>
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 mb-0" id="project-name-header"></h1>
    
    <div id="project-actions-container" class="btn-toolbar mb-2 mb-md-0">
        </div>
</div>

<div id="content-container" style="display: none;">
    <h2 id="project-name" class="mb-1"></h2>
    <p class="lead text-muted" id="project-client"></p>
    <hr>
    <div id="phases-container">
        </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const projectId = {{ project_id }};
    const currentUserId = {{ user.id }};
    const isDesignManager = {{ ('Design Manager' in user_roles) | tojson }};
    const isDocController = {{ ('Document Controller' in user_roles) | tojson }};
    const isTechEngineer = {{ ('Technical Engineer' in user_roles) | tojson }};
    const loadingState = document.getElementById('loading-state');
    const contentContainer = document.getElementById('content-container');
    const phasesContainer = document.getElementById('phases-container');
    const teamMembers = {{ team_members | tojson }};
    const toastElement = document.getElementById('responseToast');
    const toast = new bootstrap.Toast(toastElement);

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Corrected date formatting functions
    function formatDateForInput(dateString) {
        if (!dateString) return '';
        return new Date(dateString).toISOString().split('T')[0];
    }
    
    function formatDateForDisplay(dateString) {
        if (!dateString) return 'Not set';
        return new Date(dateString).toLocaleDateString(undefined, { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // The improved, robust action handler with UI safeguards
    async function handleAction(url, method = 'POST', body = null, successMessage = 'Action successful!', triggerEl = null) {
        

        let originalHtml;
        if (triggerEl) {
            originalHtml = triggerEl.innerHTML;
            triggerEl.disabled = true;
            triggerEl.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
        }

        try {
            const options = { method: method };
            if (body) {
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify(body);
            }
            const response = await fetchWithAuth(url, options); 
            const result = await response.json();
            if (!response.ok) throw new Error(result.detail || 'Action failed.');
            
            document.getElementById('toast-title').innerText = 'Success!';
            document.getElementById('toast-body').innerText = result.message || successMessage;
            toastElement.className = 'toast bg-success text-white';
            toast.show();
            
            fetchProjectDetails(); // Refresh the entire view on success
        } catch (error) {
            alert(error.message); // Show error and restore the button
            if (triggerEl) {
                triggerEl.disabled = false;
                triggerEl.innerHTML = originalHtml;
            }
        }
        // NOTE: We don't need a `finally` block because on success, the entire UI is rebuilt.
        // The button is only restored on failure.
    }

    async function fetchProjectDetails() {
        // console.log("Checking roles -> Is Design Manager?", isDesignManager, "| Is Doc Controller?", isDocController);
        try {
            const response = await fetchWithAuth(`/api/design/${projectId}`);
            if (!response.ok) {
                 const errData = await response.json();
                 throw new Error(errData.detail || 'Could not load project details.');
            }
            const project = await response.json();

            document.getElementById('project-name').textContent = project.name;
            document.getElementById('project-client').textContent = `Client: ${project.client}`;

            // --- NEW: LOGIC FOR PROJECT-LEVEL ACTIONS ---
            const projectActionsContainer = document.getElementById('project-actions-container');
            projectActionsContainer.innerHTML = ''; // Clear previous buttons

            // Check if all phases are completed
            const allPhasesComplete = project.phases.every(phase => phase.status === 'Completed');

            if (project.status === 'Completed') {
                projectActionsContainer.innerHTML = '<span class="badge bg-success fs-6">Project Completed</span>';
            } else {
                
                // Only show Close Project button if all phases are done
                if (isDesignManager && allPhasesComplete) {
                    const closeProjectBtn = document.createElement('button');
                    closeProjectBtn.className = 'btn btn-sm btn-success close-project-btn';
                    closeProjectBtn.innerHTML = '<i class="bi bi-check2-circle me-1"></i> Close Project';
                    projectActionsContainer.appendChild(closeProjectBtn);
                }
            }
            // --- END OF NEW LOGIC ---





            phasesContainer.innerHTML = '';

            project.phases.forEach(phase => {
                
                const phaseEl = document.createElement('div');
                phaseEl.className = 'card mb-4';
                let closeButtonHtml = '';
                if (isDesignManager && phase.status !== 'Completed') {
                    closeButtonHtml = `<button class="btn btn-sm btn-success close-phase-btn" data-phase-id="${phase.id}">Close Phase</button>`;
                } else if (phase.status === 'Completed') {
                    closeButtonHtml = `<span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i> Completed</span>`;
                }
                let tasksHtml = '<ul class="list-group list-group-flush">';
                
                phase.tasks.forEach(task => {
                    //console.log(`Checking Task -> ID: ${task.id}, Title: '${task.title}', Status: '${task.status}'`);
                    let assignmentCellHtml = '';
                    const dueDateForInput = formatDateForInput(task.due_date);
                    const dueDateForDisplay = formatDateForDisplay(task.due_date);
                    const isDcTask = task.title === 'Handoff to DC' || task.title === 'DC Compile & Release';
                    const isTeTask = task.title === 'Engineer Sign-off'; // Define the TE task

                    if (task.title === 'Ready for QA' && task.status === 'Open' && task.owner_id === currentUserId) {
                        assignmentCellHtml = `<form class="submit-trigger-form"><button type="submit" class="btn btn-info btn-sm">Submit for QA Review</button></form>`;
                    } else if (task.status === 'Submitted' && task.title.includes('QA Review') && isDesignManager) {
                        assignmentCellHtml = `<div class="btn-group btn-group-sm review-actions"><button type="button" class="btn btn-success" data-action="Done">Approve</button><button type="button" class="btn btn-warning" data-action="Revision Requested">Revise</button></div>`;
                    } else if (task.status === 'Submitted' && isDcTask && isDocController) {
                        assignmentCellHtml = `<button type="button" class="btn btn-info btn-sm verify-btn">Verify</button>`;
                    } else if (task.status === 'Submitted' && isTeTask && isTechEngineer) {
                        // NEW: Show sign-off button for the TE
                        assignmentCellHtml = `<button type="button" class="btn btn-primary btn-sm sign-off-btn">Sign Off</button>`;
                    } else if (task.owner) {
                        //assignmentCellHtml = `<div>${task.owner.name}</div><small class="text-muted">Due: ${dueDateForDisplay}</small>`;
                        assignmentCellHtml = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div>${task.owner.name}</div>
                                    <small class="text-muted">Due: ${dueDateForDisplay}</small>
                                </div>
                                ${isDesignManager ? `<button class="btn btn-sm btn-outline-secondary reassign-btn"><i class="bi bi-pencil-fill"></i></button>` : ''}
                            </div>
                        `;
                    }else {
                        let options = '<option value="">Assign to...</option>';
                        teamMembers.forEach(user => { options += `<option value="${user.id}">${user.name}</option>`; });
                        assignmentCellHtml = `
                            <form class="assign-task-form d-flex flex-wrap gap-2">
                                <select class="form-select form-select-sm" style="flex: 2;">${options}</select>
                                <input type="date" class="form-control form-control-sm" value="${dueDateForInput}" style="flex: 1.5;">
                                <button type="submit" class="btn btn-primary btn-sm" style="flex: 1;">Assign</button>
                            </form>`;
                    }

                     // --- THIS IS THE NEW LOGIC ---
                    // Create a link icon if a file has been submitted
                    const fileLinkIcon = task.file_link 
                        ? `<a href="${task.file_link}" target="_blank" class="ms-2" title="View Submitted File"><i class="bi bi-link-45deg"></i></a>` 
                        : '';
                    // --- END OF NEW LOGIC ---
                    
                    const statusBadges = { 'Submitted': 'bg-info', 'Revision Requested': 'bg-warning text-dark', 'Verified': 'bg-primary', 'Done': 'bg-success', 'Open': 'bg-light text-dark' };
                    const statusBadgeClass = statusBadges[task.status] || 'bg-secondary';
                    const statusHtml = `<span class="badge ${statusBadgeClass}">${task.status}</span>`;

                    tasksHtml += `<li class="list-group-item d-flex justify-content-between align-items-center" data-task-id="${task.id}">
                                      <div>${task.title}${fileLinkIcon}<a href="/design/tasks/${task.id}" class="ms-2" title="View Details & Comments">
                          <i class="bi bi-chat-right-text"></i>
                      </a></div>
                                      <div class="d-flex align-items-center gap-3">
                                          ${statusHtml}
                                          <div class="assignment-cell" style="min-width: 400px;">${assignmentCellHtml}</div>
                                      </div>
                                  </li>`;
                });
                tasksHtml += '</ul>';
                //phaseEl.innerHTML = `<div class="card-header"><h4>${phase.name}</h4></div>${tasksHtml}`;
                phaseEl.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>${phase.name}</h4>
                        <div>${closeButtonHtml}</div>
                    </div>
                    ${tasksHtml}
                `;
                phasesContainer.appendChild(phaseEl);
            });

            loadingState.style.display = 'none';
            contentContainer.style.display = 'block';
        } catch (error) {
            loadingState.innerHTML = `<p class="text-danger text-center">${error.message}</p>`;
        }
    }
    
    // Updated Event Listeners using the new handleAction function
    phasesContainer.addEventListener('click', function(e) {
        const reviewButton = e.target.closest('.review-actions button');
        const verifyButton = e.target.closest('.verify-btn');
        const signOffButton = e.target.closest('.sign-off-btn');
        const closePhaseButton = e.target.closest('.close-phase-btn');
        const reassignButton = e.target.closest('.reassign-btn');

        
        if (closePhaseButton) {
            const phaseId = closePhaseButton.dataset.phaseId;
            if (confirm('Are you sure you want to close this phase? This action cannot be undone.')) {
                handleAction(`/api/design/phases/${phaseId}/close`, 'POST', null, 'Phase closed successfully.', closePhaseButton);
            }
        }

        if (reviewButton) {
            const action = reviewButton.dataset.action;
            const taskId = reviewButton.closest('li').dataset.taskId;
            const group = reviewButton.closest('.btn-group');
            handleAction(`/api/design/tasks/${taskId}/review`, 'POST', { status: action }, 'Task reviewed.', group);
        }
        if (verifyButton) {
            const taskId = verifyButton.closest('li').dataset.taskId;
            handleAction(`/api/design/tasks/${taskId}/verify`, 'POST', null, 'Task verified.', verifyButton);
        }
        
        if (signOffButton) {
            const taskId = signOffButton.closest('li').dataset.taskId;
            // Optionally, prompt for notes
            const notes = prompt("Enter any sign-off notes (optional):");
            handleAction(`/api/design/tasks/${taskId}/sign-off`, 'POST', { notes: notes }, 'Task signed off.', signOffButton);
        }
        if (reassignButton) {
            const cell = reassignButton.closest('.assignment-cell');
            const taskId = reassignButton.closest('li').dataset.taskId;
            const projectData = JSON.parse(localStorage.getItem('currentProjectData'));
            let currentTask;
            if (projectData) {
                projectData.phases.forEach(p => { const f = p.tasks.find(t => t.id == taskId); if(f) currentTask = f; });
            }
            let options = '<option value="">Assign to...</option>';
            teamMembers.forEach(user => {
                const selected = currentTask && user.id === currentTask.owner_id ? 'selected' : '';
                options += `<option value="${user.id}" ${selected}>${user.name}</option>`;
            });
            const dueDateForInput = formatDateForInput(currentTask ? currentTask.due_date : '');
            cell.innerHTML = `
                <form class="assign-task-form d-flex flex-wrap gap-2">
                    <select class="form-select form-select-sm" style="flex: 2;">${options}</select>
                    <input type="date" class="form-control form-control-sm" value="${dueDateForInput}" style="flex: 1.5;">
                    <button type="submit" class="btn btn-primary btn-sm" style="flex: 1;">Update</button>
                </form>`;
        }
    });

     // --- ADD THIS NEW, SEPARATE LISTENER for the page header actions ---
    const projectActionsContainer = document.getElementById('project-actions-container');
    projectActionsContainer.addEventListener('click', function(e) {
        const closeProjectButton = e.target.closest('.close-project-btn');
        if (closeProjectButton) {
            if (confirm('Are you sure you want to close this entire project?')) {
                handleAction(`/api/design/projects/${projectId}/close`, 'POST', null, 'Project closed successfully.', closeProjectButton);
            }
        }
    });

    phasesContainer.addEventListener('submit', function(e) {
        e.preventDefault();
        const form = e.target;
        const taskId = form.closest('li').dataset.taskId;
        const submitBtn = form.querySelector('button[type="submit"]');

        if (form.classList.contains('assign-task-form')) {
            const ownerId = form.querySelector('select').value;
            const dueDate = form.querySelector('input[type="date"]').value;
            if (ownerId && taskId) {
                handleAction(`/api/design/tasks/${taskId}/assign`, 'POST', { owner_id: parseInt(ownerId), due_date: dueDate }, 'Task assigned.', submitBtn);
            }
        }
        if (form.classList.contains('submit-trigger-form')) {
            handleAction(`/api/design/tasks/${taskId}/submit`, 'POST', {}, 'Submitted for QA.', submitBtn);
        }
    });

    fetchProjectDetails();
});
</script>
{% endblock %}