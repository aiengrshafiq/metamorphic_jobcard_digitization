{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div id="loading-state" class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading requisition details...</p>
    </div>

    <div id="content-container" style="display: none;">
        <div class="d-flex justify-content-between align-items-center pb-2 mb-3 border-bottom">
        <h2 class="h2 mb-0" id="mr-number-header"></h2>
        <div id="page-actions-container" class="btn-toolbar mb-2 mb-md-0">
            </div>
    </div>
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-3">MR Number</dt>
                            <dd class="col-sm-9" id="mr-number"></dd>
                            
                            <dt class="col-sm-3">Status</dt>
                            <dd class="col-sm-9" id="status"></dd>
                            
                            <hr class="my-3">
                            
                            <dt class="col-sm-3">Project</dt>
                            <dd class="col-sm-9" id="project"></dd>
                            
                            <dt class="col-sm-3">Requested By</dt>
                            <dd class="col-sm-9" id="requested-by"></dd>
                            
                            <dt class="col-sm-3">Request Date</dt>
                            <dd class="col-sm-9" id="request-date"></dd>
                            
                            <hr class="my-3">

                            <dt class="col-sm-3">Material Type</dt>
                            <dd class="col-sm-9" id="material-type"></dd>
                            
                            <dt class="col-sm-12">Materials & Quantity</dt>
                            <dd class="col-sm-12">
                                <table class="table table-sm table-bordered mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Material</th>
                                            <th class="text-end">Quantity</th>
                                            <th>Unit</th>
                                        </tr>
                                    </thead>
                                    <tbody id="materials-table-body">
                                        </tbody>
                                </table>
                            </dd>
                        </dl>
                    </div>
                </div>
                 <div class="card shadow-sm mt-4">
                <div class="card-header"><h5 class="mb-0">Additional Details</h5></div>
                <div class="card-body">
                    {% if is_privileged or 'Procurement' in user_roles or 'Project Manager' in user_roles or 'QS' in user_roles %}
                    <div class="mb-3">
                        <label for="technical-spec" class="form-label">Technical Specification (PM)</label>
                        <textarea id="technical-spec" class="form-control" rows="4"></textarea>
                        <button class="btn btn-sm btn-outline-primary mt-2 save-mr-details-btn" data-field="technical_spec">Save Spec</button>
                    </div>
                    {% endif %}

                    {% if is_privileged or 'Procurement' in user_roles or 'QS' in user_roles or 'Project Manager' in user_roles %}
                    <div class="mb-3">
                        <label for="boq-mapping" class="form-label">BOQ Mapping (QS)</label>
                        <textarea id="boq-mapping" class="form-control" rows="4"></textarea>
                        <button class="btn btn-sm btn-outline-primary mt-2 save-mr-details-btn" data-field="boq_mapping">Save BOQ Mapping</button>
                    </div>
                    {% endif %}
                </div>
            </div>
                <div class="card shadow-sm mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-chat-dots-fill me-2"></i>Comments</h5>
                    </div>
                    <div class="card-body">
                        <div id="comment-list" class="mb-3">
                            </div>
                        <form id="comment-form">
                            <div class="mb-3">
                                <label for="comment-text" class="form-label">Add a new comment</label>
                                <textarea class="form-control" id="comment-text" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary" id="submit-comment-btn">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                Post Comment
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header"><h5 class="mb-0">Approval & Logistics</h5></div>
                    <div class="card-body">
                        <dl class="row mb-0">
                             <dt class="col-sm-5">Urgency</dt>
                             <dd class="col-sm-7" id="urgency"></dd>
                             
                             <dt class="col-sm-5">Required By</dt>
                             <dd class="col-sm-7" id="required-date"></dd>

                             <dt class="col-sm-5">MR Approval</dt>
                             <dd class="col-sm-7" id="mr-approval"></dd>

                             <dt class="col-sm-5">PM Approval</dt>
                             <dd class="col-sm-7" id="pm-approval"></dd>
                             
                             <dt class="col-sm-5">Commercial Approval</dt>
                             <dd class="col-sm-7" id="qs-approval"></dd>

                             <hr class="my-3">
                             
                             <dt class="col-sm-5">Supplier</dt>
                             <dd class="col-sm-7" id="supplier"></dd>

                             <dt class="col-sm-5">LPO Number</dt>
                             <dd class="col-sm-7" id="lpo-number"></dd>
                             
                             <dt class="col-sm-5">Payment Status</dt>
                             <dd class="col-sm-7" id="payment-status"></dd>

                             <hr class="my-3">

                             <dt class="col-12">Remarks</dt>
                             <dd class="col-12 mt-1"><p id="remarks" class="text-muted"></p></dd>
                        </dl>
                    </div>
                </div>
                <div class="col-lg-12">
                <div class="card shadow-sm">
                    </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-box-arrow-in-down me-2"></i>Material Receipts</h5></div>
                    <div class="card-body">
                        <div id="receipts-container">
                            </div>
                    </div>
                </div>
                </div>
            </div>
           
        </div>
        
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const reqId = {{ req_id }};
    const loadingState = document.getElementById('loading-state');
    const contentContainer = document.getElementById('content-container');
    const commentList = document.getElementById('comment-list');
    const commentForm = document.getElementById('comment-form');
    const commentText = document.getElementById('comment-text');
    const submitCommentBtn = document.getElementById('submit-comment-btn');
    const receiptsContainer = document.getElementById('receipts-container'); // Get the new container
    const materialsTableBody = document.getElementById('materials-table-body');
    const toastElement = document.getElementById('responseToast');
    const toast = new bootstrap.Toast(toastElement);

    
    
    function formatApprovalStatus(status) {
        if (status === 'Approved') return `<span class="badge bg-success">${status}</span>`;
        if (status === 'Rejected') return `<span class="badge bg-danger">${status}</span>`;
        return `<span class="badge bg-warning text-dark">${status || 'Pending'}</span>`;
    }
    
    function renderComments(comments) {
        commentList.innerHTML = '';
        if (comments && comments.length > 0) {
            comments.forEach(comment => {
                const commentEl = document.createElement('div');
                commentEl.className = 'd-flex mb-3 border-bottom pb-2';
                const commentDate = new Date(comment.created_at).toLocaleString();
                commentEl.innerHTML = `
                    <div class="flex-shrink-0 me-3"><i class="bi bi-person-circle fs-3 text-secondary"></i></div>
                    <div class="flex-grow-1">
                        <h6 class="mt-0 mb-1">${comment.comment_by.name}</h6>
                        <p class="mb-1" style="white-space: pre-wrap;">${comment.comment_text}</p>
                        <small class="text-muted">${commentDate}</small>
                    </div>`;
                commentList.appendChild(commentEl);
            });
        } else {
            commentList.innerHTML = '<p class="text-muted text-center">No comments yet.</p>';
        }
    }

    // --- NEW FUNCTION TO RENDER RECEIPTS ---
    function renderReceipts(receipts) {
        receiptsContainer.innerHTML = '';
        if (receipts && receipts.length > 0) {
            receipts.forEach((receipt, index) => {
                const receiptDate = new Date(receipt.created_at).toLocaleString();
                let imagesHtml = '';
                if (receipt.images && receipt.images.length > 0) {
                    imagesHtml += '<div class="d-flex flex-wrap gap-2 mt-2">';
                    receipt.images.forEach(img => {
                        imagesHtml += `<a href="${img.blob_url}" target="_blank" title="${img.file_name}"><img src="${img.blob_url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;"></a>`;
                    });
                    imagesHtml += '</div>';
                }

                const receiptEl = document.createElement('div');
                receiptEl.className = 'border-bottom pb-2 mb-2';
                receiptEl.innerHTML = `
                    <h6>Delivery Status: <span class="badge bg-info">${receipt.delivery_status}</span></h6>
                    <small class="text-muted">Received by <strong>${receipt.received_by.name}</strong> on ${receiptDate}</small>
                    ${receipt.notes ? `<p class="mb-1 mt-2 fst-italic">"${receipt.notes}"</p>` : ''}
                    ${imagesHtml}
                `;
                receiptsContainer.appendChild(receiptEl);
            });
        } else {
            receiptsContainer.innerHTML = '<p class="text-muted">No receipts have been recorded yet.</p>';
        }
    }

     // --- NEW FUNCTION TO RENDER THE MATERIALS TABLE ---
    function renderMaterials(items, historyData) {
        materialsTableBody.innerHTML = '';
        if (items && items.length > 0) {
            items.forEach(item => {
                const row = document.createElement('tr');
                const materialId = item.material.id;
                let historyHtml = '';

                // Check if there is history for this material
                if (historyData && historyData[materialId]) {
                    const history = historyData[materialId];
                    const historyDate = new Date(history.request_date).toLocaleDateString();
                    historyHtml = `
                        <br>
                        <small class="text-muted fst-italic">
                            Last ordered: ${parseFloat(history.quantity).toFixed(2)} ${history.unit} for ${history.project_name} on ${historyDate}
                        </small>
                    `;
                }

                row.innerHTML = `
                    <td>${item.material.name}${historyHtml}</td>
                    <td class="text-end">${parseFloat(item.quantity).toFixed(2)}</td>
                    <td>${item.material.unit}</td>
                `;
                materialsTableBody.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="3" class="text-center text-muted">No materials listed.</td>`;
            materialsTableBody.appendChild(row);
        }
    }

    async function fetchRequisitionDetails() {
        

        try {
            const response = await fetchWithAuth(`/api/requisition-details/${reqId}`);
            if (!response.ok) throw new Error('Could not load requisition details.');
            
            const data = await response.json();
            

            // --- NEW: Step 2: Fetch order history for the items in this requisition ---
            let historyData = {};
            if (data.items && data.items.length > 0) {
                const materialIds = data.items.map(item => item.material.id);
                const historyResponse = await fetchWithAuth('/api/materials/last-order-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ material_ids: materialIds, current_req_id: reqId })
                });
                if (historyResponse.ok) {
                    historyData = await historyResponse.json();
                }
            }
            // -------------------------------------------------------------------------

            const techSpecEl = document.getElementById('technical-spec');
            if (techSpecEl) {
                techSpecEl.value = data.technical_spec || '';
            }
            const boqMappingEl = document.getElementById('boq-mapping');
            if (boqMappingEl) {
                boqMappingEl.value = data.boq_mapping || '';
            }


            // Populate main fields
            document.getElementById('mr-number').textContent = data.mr_number || 'N/A';
            document.getElementById('status').innerHTML = `<span class="badge bg-primary">${data.status}</span>`;
            document.getElementById('project').textContent = data.project ? data.project.name : 'N/A';
            document.getElementById('requested-by').textContent = data.requested_by ? data.requested_by.name : 'N/A';
            document.getElementById('request-date').textContent = new Date(data.request_date).toLocaleDateString();
            document.getElementById('material-type').textContent = data.material_type;
            //document.getElementById('material-quantity').textContent = data.material_with_quantity;
            
            // Populate sidebar fields
            document.getElementById('urgency').textContent = data.urgency;
            document.getElementById('required-date').textContent = new Date(data.required_delivery_date).toLocaleDateString();
            document.getElementById('mr-approval').innerHTML = formatApprovalStatus(data.mr_approval);
            document.getElementById('pm-approval').innerHTML = formatApprovalStatus(data.pm_approval);
            document.getElementById('qs-approval').innerHTML = formatApprovalStatus(data.qs_approval);
            document.getElementById('supplier').textContent = data.supplier ? data.supplier.name : 'Not Assigned';
            document.getElementById('lpo-number').textContent = data.lpo_number || 'N/A';
            document.getElementById('payment-status').textContent = data.payment_status || 'N/A';
            document.getElementById('remarks').textContent = data.remarks || 'No remarks.';
            
            // Render dynamic sections
            renderComments(data.comments);
            renderReceipts(data.receipts); // <-- CALL THE NEW FUNCTION
            renderMaterials(data.items, historyData);

             // --- NEW: LOGIC TO SHOW "CREATE LPO" BUTTON ---
            const actionsContainer = document.getElementById('page-actions-container');
            actionsContainer.innerHTML = ''; // Clear previous buttons

            if (data.mr_approval === 'Approved' && data.pm_approval === 'Approved' && data.qs_approval === 'Approved') {
                const createLpoBtn = document.createElement('a');
                createLpoBtn.href = '/lpos/new';
                createLpoBtn.className = 'btn btn-primary';
                createLpoBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Create LPO';
                actionsContainer.appendChild(createLpoBtn);
            }
            // --- END OF NEW LOGIC ---

            loadingState.style.display = 'none';
            contentContainer.style.display = 'block';

        } catch (error) {
            loadingState.innerHTML = `<p class="text-danger">${error.message}</p>`;
        }
    }
    
    commentForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        
        const spinner = submitCommentBtn.querySelector('.spinner-border');
        submitCommentBtn.disabled = true;
        spinner.style.display = 'inline-block';

        // const formData = new FormData();
        // formData.append('comment_text', commentText.value);

        try {
            const response = await fetchWithAuth(`/api/requisition-details/${reqId}/comments`, {
                method: 'POST',
                body: new FormData(commentForm)
            });
            const newComment = await response.json();
            if (!response.ok) throw new Error(newComment.detail || 'Failed to post comment.');
            
            fetchRequisitionDetails(); // Re-fetch all data to ensure sync
            commentText.value = '';

        } catch (error) {
            document.getElementById('toast-title').innerText = 'Error!';
            document.getElementById('toast-body').innerText = error.message;
            toastElement.className = 'toast bg-danger text-white';
            toast.show();
        } finally {
            submitCommentBtn.disabled = false;
            spinner.style.display = 'none';
        }
    });

    contentContainer.addEventListener('click', async function(e) {
        if (e.target.classList.contains('save-mr-details-btn')) {
            const button = e.target;
            const fieldName = button.dataset.field;
            const textarea = document.getElementById(fieldName.replace('_', '-'));
            
            const payload = {};
            payload[fieldName] = textarea.value;

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            try {
                const response = await fetchWithAuth(`/api/requisition-details/${reqId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Failed to save.');

                document.getElementById('toast-title').innerText = 'Success!';
                document.getElementById('toast-body').innerText = result.message;
                toastElement.className = 'toast bg-success text-white';
                toast.show();

            } catch (error) {
                 document.getElementById('toast-title').innerText = 'Error!';
                document.getElementById('toast-body').innerText = error.message;
                toastElement.className = 'toast bg-danger text-white';
                toast.show();
            } finally {
                button.disabled = false;
                button.innerHTML = `Save ${fieldName === 'technical_spec' ? 'Spec' : 'BOQ'}`;
            }
        }
    });

    fetchRequisitionDetails();
});
</script>
{% endblock %}